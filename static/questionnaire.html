<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Final Questionnaire</title>
    <link rel="stylesheet" href="style.css">
    <style>
    </style>
</head>
<body>

<div id="taskNavigator">
    <div id="taskDragHandle"><strong>Drag to Move</strong></div>
    <div id="taskLinks">Loading...</div>
    <button type="button" onclick="document.getElementById('feedbackForm').requestSubmit()">
        ‚úÖ Submit All
    </button>
</div>


<div class="container">
    <h1>Rate the Descriptions</h1>
    <div class="instruction-box">
        <p>
            On this page, you will rate the <strong>LLM-generated descriptions</strong> of Petri nets .
        <p/>
        <p>
            You will see several <strong>different descriptions of the same Petri net</strong>, each generated by a different
                                              approach.
            Please evaluate each description independently, based on its own quality.
        </p>
        <p>Rate each description using the following criteria, on a scale from <strong>1 (very poor)
        </strong> to <strong>10 (excellent)</strong>:</p>
        <ol>
            <li><strong>Accuracy</strong> ‚Äì How well does the translation reflect the original model?</li>
            <li><strong>Readability</strong> ‚Äì Is the text easy to understand, well-structured, and clearly written?
            </li>
            <li><strong>Overall Impression</strong> ‚Äì  Your overall judgment of the translation‚Äôs quality, including
                how helpful it was for understanding the Petri net process model.
            </li>
        </ol>
    </div>

    <div id="taskTitle">Loading tasks...</div>
    <form id="feedbackForm"></form>

    <div style="margin-top: 2rem;">
        <button type="submit" form="feedbackForm">‚úÖ Submit Feedback</button>
        <p id="submitStatus"></p>
    </div>
</div>

<script>
    const userId = localStorage.getItem("userId");
    const email = localStorage.getItem("email");
    const packageId = localStorage.getItem("taskId");

    if (!userId || !email || !packageId) {
        alert("Session missing. Please login again.");
        window.location.href = "login.html";
    }

    fetch(`/package/${packageId}`)
        .then(res => res.json())
        .then(data => {
            const tasks = data.tasks;
            document.getElementById("taskTitle").innerText = `Package: ${packageId} (${tasks.length} tasks)`;
            const form = document.getElementById("feedbackForm");
            const nav = document.getElementById("taskLinks");
            nav.innerHTML = "";
            tasks.sort((a, b) => a.localeCompare(b, undefined, {numeric: true}));

            tasks.forEach(taskId => {
                const block = document.createElement("div");
                block.classList.add("task-block");
                block.id = taskId;

                const navLink = document.createElement("a");
                navLink.href = `#${taskId}`;
                navLink.textContent = taskId;
                nav.appendChild(navLink);

                fetch(`/tasks/${taskId}`)
                    .then(res => res.json())
                    .then(task => {
                        block.innerHTML = `
  <h3>${taskId}</h3>
  <div class="task-content">
    <div class="task-left">
      <strong>Original Petri Net:</strong><br>
        <div class="image-wrapper">
          <img src="${task.original_image_url}" class="zoomable-image" data-zoom="1" />
        </div>

      <div class="zoom-controls">
        <button type="button" onclick="zoomImage(this, 1.2)">üîç Zoom In</button>
        <button type="button" onclick="zoomImage(this, 0.8)">üîé Zoom Out</button>
        <button type="button" onclick="zoomImage(this, 1, true)">‚ôªÔ∏è Reset</button>
      </div>

      <strong>Description:</strong><br>
      <iframe src="${task.translation_file_url}" height="550"></iframe>
    </div>

    <div class="task-right">
      <label>Accuracy (1‚Äì10)
        <select name="accuracy_${taskId}" required>
          <option value="">Select</option>
          ${[...Array(10).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join("")}
        </select>
      </label>
      <textarea name="acc_comment_${taskId}" placeholder="Optional accuracy comments" rows="2"></textarea>

      <label>Readability (1‚Äì10)
        <select name="readability_${taskId}" required>
          <option value="">Select</option>
          ${[...Array(10).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join("")}
        </select>
      </label>
      <textarea name="read_comment_${taskId}" placeholder="Optional readability comments" rows="2"></textarea>

      <label>Overall Impression (1‚Äì10)
        <select name="overall_${taskId}" required>
          <option value="">Select</option>
          ${[...Array(10).keys()].map(i => `<option value="${i + 1}">${i + 1}</option>`).join("")}
        </select>
      </label>
      <textarea name="other_comment_${taskId}" placeholder="Additional comments..." rows="2"></textarea>
    </div>
  </div>
`;

                        form.appendChild(block);
                    });
            });
        });

    document.getElementById("feedbackForm").addEventListener("submit", function (e) {
        e.preventDefault();
        const formData = new FormData(this);
        const ratings = [];

        this.querySelectorAll("div.task-block").forEach(group => {
            const header = group.querySelector("h3");
            if (!header) return;

            const taskId = header.innerText;
            ratings.push({
                task_id: taskId,
                accuracy: parseInt(formData.get(`accuracy_${taskId}`)),
                accuracy_comment: formData.get(`acc_comment_${taskId}`),
                readability: parseInt(formData.get(`readability_${taskId}`)),
                readability_comment: formData.get(`read_comment_${taskId}`),
                overall: parseInt(formData.get(`overall_${taskId}`)),
                overall_comment: formData.get(`other_comment_${taskId}`)
            });
        });

        const payload = {
            user_id: userId,
            email: email,
            package_id: packageId,
            ratings: ratings,
            timestamp: new Date().toISOString()
        };

        fetch("/submit-rating", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(payload)
        })
            .then(res => res.json())
            .then(data => {
                document.getElementById("submitStatus").innerText = data.success ? "‚úÖ Submitted!" : "‚ùå Error submitting.";
                if (data.success) {
                    alert(" You have finished! Thanks!!");
                    localStorage.clear();
                    setTimeout(() => window.location.href = "login.html", 3000);
                }
            });
    });

    function zoomImage(button, factor, reset = false) {
        const wrapper = button.closest(".task-left");
        const img = wrapper.querySelector("img.zoomable-image");

        let current = parseFloat(img.getAttribute("data-zoom") || "1");

        if (reset) {
            current = 1;
        } else {
            current *= factor;
            if (current > 4) current = 4; // optional cap
        }

        img.style.transform = `scale(${current})`;
        img.setAttribute("data-zoom", current.toFixed(2));
    }

    // Attach Ctrl+scroll zoom to each zoomable image when it‚Äôs created
    const observer = new MutationObserver(() => {
        document.querySelectorAll("img.zoomable-image").forEach(img => {
            if (img.dataset.listenerAttached) return;

            img.addEventListener("wheel", function (e) {
                if (!e.ctrlKey) return;
                e.preventDefault();

                let current = parseFloat(img.getAttribute("data-zoom") || "1");
                const factor = e.deltaY < 0 ? 1.1 : 0.9;

                current *= factor;
                current = Math.min(Math.max(current, 0.1), 4);

                img.style.transform = `scale(${current})`;
                img.setAttribute("data-zoom", current.toFixed(2));
            }, {passive: false});

            img.dataset.listenerAttached = "true";
        });
    });

    // Start observing for dynamically loaded tasks
    observer.observe(document.getElementById("feedbackForm"), {childList: true, subtree: true});

</script>
<script>
(function () {
  const panel = document.getElementById("taskNavigator");
  const handle = document.getElementById("taskDragHandle");

  // Wait for both panel and handle to exist before attaching behavior
  if (!panel || !handle) return;

  let isDragging = false;
  let dragStartX = 0;
  let dragStartY = 0;
  let offsetX = 0;
  let offsetY = 0;
  let suppressClick = false;

  handle.style.cursor = "move";
  panel.style.position = "fixed";
  panel.style.zIndex = 1000;

  handle.addEventListener("mousedown", (e) => {
    isDragging = true;
    dragStartX = e.clientX;
    dragStartY = e.clientY;
    const rect = panel.getBoundingClientRect();
    offsetX = e.clientX - rect.left;
    offsetY = e.clientY - rect.top;
    suppressClick = false;
    e.preventDefault();
  });

  document.addEventListener("mousemove", (e) => {
    if (!isDragging) return;

    const dx = e.clientX - dragStartX;
    const dy = e.clientY - dragStartY;
    const distance = Math.sqrt(dx * dx + dy * dy);

    if (distance > 4) {
      suppressClick = true;
      panel.style.left = `${e.clientX - offsetX}px`;
      panel.style.top = `${e.clientY - offsetY}px`;
      panel.style.right = "auto";
      panel.style.bottom = "auto";
    }
  });

  document.addEventListener("mouseup", () => {
    isDragging = false;
  });

  handle.addEventListener("click", (e) => {
    if (suppressClick) {
      e.stopImmediatePropagation();
      e.preventDefault();
      suppressClick = false;
    }
  }, true);
})();
</script>
</body>
</html>
